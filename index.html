<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROK 헌법 Ai </title>
    <style>
        /* From Uiverse.io by Lakshay-art */ 
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: linear-gradient(135deg, #000000 0%, #1a0a2e 50%, #2d1b69 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Arial', sans-serif;
            overflow: hidden;
        }

        .grid {
            display: none; /* 체크무늬 제거 */
        }

        .white,
        .border,
        .darkBorderBg,
        .glow {
            max-height: 70px;
            max-width: 314px;
            height: 100%;
            width: 100%;
            position: absolute;
            overflow: hidden;
            z-index: -1;
            /* Border Radius */
            border-radius: 12px;
            filter: blur(3px);
        }

        .input {
            background-color: rgba(1, 2, 1, 0.9);
            border: none;
            width: 301px;
            height: 56px;
            border-radius: 10px;
            color: #ffffff;
            padding-inline: 59px;
            font-size: 18px;
            font-weight: 500;
            text-shadow: 0 0 1px rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.1);
        }

        #poda {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .input::placeholder {
            color: rgba(192, 185, 192, 0.8);
            font-weight: 400;
        }

        .input:focus {
            outline: none;
        }

        #input-mask {
            display: none; /* 입력 마스크 완전 제거 */
        }

        #pink-mask {
            pointer-events: none;
            width: 30px;
            height: 20px;
            position: absolute;
            background: #cf30aa;
            top: 10px;
            left: 5px;
            filter: blur(20px);
            opacity: 0.8;
            transition: all 2s;
        }

        #main:hover > #pink-mask {
            opacity: 0;
        }

        .white {
            max-height: 63px;
            max-width: 307px;
            border-radius: 10px;
            filter: blur(2px);
        }

        .white::before {
            content: "";
            z-index: -2;
            text-align: center;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(83deg);
            position: absolute;
            width: 600px;
            height: 600px;
            background-repeat: no-repeat;
            background-position: 0 0;
            filter: brightness(1.4);
            background-image: conic-gradient(
                rgba(0, 0, 0, 0) 0%,
                #a099d8,
                rgba(0, 0, 0, 0) 8%,
                rgba(0, 0, 0, 0) 50%,
                #dfa2da,
                rgba(0, 0, 0, 0) 58%
            );
            transition: all 2s;
        }

        .border {
            max-height: 59px;
            max-width: 303px;
            border-radius: 11px;
            filter: blur(0.5px);
        }

        .border::before {
            content: "";
            z-index: -2;
            text-align: center;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(70deg);
            position: absolute;
            width: 600px;
            height: 600px;
            filter: brightness(1.3);
            background-repeat: no-repeat;
            background-position: 0 0;
            background-image: conic-gradient(
                #1c191c,
                #402fb5 5%,
                #1c191c 14%,
                #1c191c 50%,
                #cf30aa 60%,
                #1c191c 64%
            );
            transition: all 2s;
        }

        .darkBorderBg {
            max-height: 65px;
            max-width: 312px;
        }

        .darkBorderBg::before {
            content: "";
            z-index: -2;
            text-align: center;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(82deg);
            position: absolute;
            width: 600px;
            height: 600px;
            background-repeat: no-repeat;
            background-position: 0 0;
            background-image: conic-gradient(
                rgba(0, 0, 0, 0),
                #18116a,
                rgba(0, 0, 0, 0) 10%,
                rgba(0, 0, 0, 0) 50%,
                #6e1b60,
                rgba(0, 0, 0, 0) 60%
            );
            transition: all 2s;
        }

        #poda:hover > .darkBorderBg::before {
            transform: translate(-50%, -50%) rotate(262deg);
        }

        #poda:hover > .glow::before {
            transform: translate(-50%, -50%) rotate(240deg);
        }

        #poda:hover > .white::before {
            transform: translate(-50%, -50%) rotate(263deg);
        }

        #poda:hover > .border::before {
            transform: translate(-50%, -50%) rotate(250deg);
        }

        #poda:hover > .darkBorderBg::before {
            transform: translate(-50%, -50%) rotate(-98deg);
        }

        #poda:hover > .glow::before {
            transform: translate(-50%, -50%) rotate(-120deg);
        }

        #poda:hover > .white::before {
            transform: translate(-50%, -50%) rotate(-97deg);
        }

        #poda:hover > .border::before {
            transform: translate(-50%, -50%) rotate(-110deg);
        }

        #poda:focus-within > .darkBorderBg::before {
            transform: translate(-50%, -50%) rotate(442deg);
            transition: all 4s;
        }

        #poda:focus-within > .glow::before {
            transform: translate(-50%, -50%) rotate(420deg);
            transition: all 4s;
        }

        #poda:focus-within > .white::before {
            transform: translate(-50%, -50%) rotate(443deg);
            transition: all 4s;
        }

        #poda:focus-within > .border::before {
            transform: translate(-50%, -50%) rotate(430deg);
            transition: all 4s;
        }

        .glow {
            overflow: hidden;
            filter: blur(30px);
            opacity: 0.4;
            max-height: 130px;
            max-width: 354px;
        }

        .glow:before {
            content: "";
            z-index: -2;
            text-align: center;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(60deg);
            position: absolute;
            width: 999px;
            height: 999px;
            background-repeat: no-repeat;
            background-position: 0 0;
            /*border color, change middle color*/
            background-image: conic-gradient(
                #000,
                #402fb5 5%,
                #000 38%,
                #000 50%,
                #cf30aa 60%,
                #000 87%
            );
            transition: all 2s;
        }

        @keyframes rotate {
            100% {
                transform: translate(-50%, -50%) rotate(450deg);
            }
        }

        @keyframes leftright {
            0% {
                transform: translate(0px, 0px);
                opacity: 1;
            }

            49% {
                transform: translate(250px, 0px);
                opacity: 0;
            }
            80% {
                transform: translate(-40px, 0px);
                opacity: 0;
            }

            100% {
                transform: translate(0px, 0px);
                opacity: 1;
            }
        }

        #filter-icon {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
            max-height: 40px;
            max-width: 38px;
            height: 100%;
            width: 100%;
            isolation: isolate;
            overflow: hidden;
            /* Border Radius */
            border-radius: 10px;
            background: linear-gradient(180deg, #161329, black, #1d1b4b);
            border: 1px solid transparent;
        }

        .filterBorder {
            height: 42px;
            width: 40px;
            position: absolute;
            overflow: hidden;
            top: 7px;
            right: 7px;
            border-radius: 10px;
        }

        .filterBorder::before {
            content: "";
            text-align: center;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(90deg);
            position: absolute;
            width: 600px;
            height: 600px;
            background-repeat: no-repeat;
            background-position: 0 0;
            filter: brightness(1.35);
            background-image: conic-gradient(
                rgba(0, 0, 0, 0),
                #3d3a4f,
                rgba(0, 0, 0, 0) 50%,
                rgba(0, 0, 0, 0) 50%,
                #3d3a4f,
                rgba(0, 0, 0, 0) 100%
            );
            animation: rotate 4s linear infinite;
        }

        #main {
            position: relative;
        }

        #search-icon {
            position: absolute;
            left: 20px;
            top: 15px;
            color: rgba(192, 185, 192, 0.9);
            font-size: 20px;
            text-shadow: 0 0 2px rgba(255, 255, 255, 0.2);
        }

        /* 추가 스타일 */
        .title {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2rem;
            text-shadow: 0 0 10px rgba(207, 48, 170, 0.5);
        }

        .subtitle {
            color: #c0b9c0;
            text-align: center;
            margin-bottom: 50px;
            font-size: 1rem;
        }

        /* 모바일 메인 인터페이스 최적화 */
        @media (max-width: 768px) {
            .title {
                font-size: 1.5rem;
                margin-bottom: 20px;
            }

            .subtitle {
                font-size: 0.9rem;
                margin-bottom: 30px;
            }

            #main {
                width: 90%;
                max-width: 320px;
            }

            .input {
                width: 280px;
                height: 50px;
                font-size: 16px;
                padding-inline: 50px;
            }

            #search-icon {
                left: 15px;
                top: 12px;
                font-size: 18px;
            }

            #filter-icon {
                top: 6px;
                right: 6px;
                max-height: 36px;
                max-width: 34px;
            }

            .filterBorder {
                height: 38px;
                width: 36px;
                top: 5px;
                right: 5px;
            }

            .white,
            .border,
            .darkBorderBg,
            .glow {
                max-height: 60px;
                max-width: 290px;
            }
        }

        /* 챗봇 모달 스타일 */
        .chatbot-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chatbot-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .chatbot-container {
            background: rgba(26, 10, 46, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            width: 95%;
            max-width: 800px;
            height: 90vh;
            max-height: 600px;
            border: 1px solid rgba(207, 48, 170, 0.3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            transform: scale(0.9);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        /* 모바일 챗봇 최적화 */
        @media (max-width: 768px) {
            .chatbot-container {
                width: 100%;
                height: 100vh;
                max-height: none;
                border-radius: 0;
                margin: 0;
            }

            .chatbot-header {
                padding: 15px 20px;
            }

            .chatbot-title {
                font-size: 1.1rem;
            }

            .chatbot-avatar {
                width: 28px;
                height: 28px;
                font-size: 0.9rem;
            }

            .conversation-counter {
                position: static;
                margin-left: auto;
                font-size: 0.7rem;
                padding: 3px 8px;
            }

            .chatbot-messages {
                padding: 15px;
            }

            .message-content {
                max-width: 85%;
                padding: 10px 14px;
                font-size: 14px;
            }

            .chatbot-input-area {
                padding: 15px;
            }

            .chatbot-input {
                padding: 10px 14px;
                font-size: 14px;
                min-height: 40px;
            }

            .chatbot-send-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }

            .share-btn {
                top: 15px;
                right: 15px;
                padding: 6px 10px;
                font-size: 11px;
            }
        }

        .chatbot-modal.show .chatbot-container {
            transform: scale(1);
        }

        /* 챗봇 헤더 */
        .chatbot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid rgba(207, 48, 170, 0.2);
            background: rgba(207, 48, 170, 0.1);
            border-radius: 20px 20px 0 0;
        }

        .chatbot-title {
            color: white;
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chatbot-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #402fb5, #cf30aa);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1rem;
        }

        .chatbot-close {
            background: none;
            border: none;
            color: #c0b9c0;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .chatbot-close:hover {
            background: rgba(207, 48, 170, 0.1);
            color: #cf30aa;
        }

        /* 챗봇 메시지 영역 */
        .chatbot-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .chatbot-message {
            display: flex;
            gap: 12px;
            animation: messageSlideIn 0.3s ease;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chatbot-message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .message-avatar.bot {
            background: linear-gradient(135deg, #402fb5, #cf30aa);
            color: white;
        }

        .message-avatar.user {
            background: linear-gradient(135deg, #cf30aa, #402fb5);
            color: white;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .message-content.bot {
            background: rgba(207, 48, 170, 0.1);
            color: #c0b9c0;
            border: 1px solid rgba(207, 48, 170, 0.2);
        }

        .message-content.user {
            background: linear-gradient(135deg, #402fb5, #cf30aa);
            color: white;
        }

        /* 챗봇 입력 영역 */
        .chatbot-input-area {
            padding: 20px;
            border-top: 1px solid rgba(207, 48, 170, 0.2);
            background: rgba(207, 48, 170, 0.05);
            border-radius: 0 0 20px 20px;
        }

        .chatbot-input-container {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .chatbot-input {
            flex: 1;
            background: rgba(1, 2, 1, 0.9);
            border: 1px solid rgba(207, 48, 170, 0.3);
            border-radius: 20px;
            color: #ffffff;
            padding: 12px 16px;
            font-size: 14px;
            resize: none;
            min-height: 44px;
            max-height: 120px;
            backdrop-filter: blur(10px);
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.1);
        }

        .chatbot-input:focus {
            outline: none;
            border-color: #cf30aa;
            box-shadow: 0 0 0 2px rgba(207, 48, 170, 0.2);
        }

        .chatbot-input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chatbot-input::placeholder {
            color: rgba(192, 185, 192, 0.6);
        }

        .chatbot-send-btn {
            background: linear-gradient(135deg, #402fb5, #cf30aa);
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .chatbot-send-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(207, 48, 170, 0.3);
        }

        .chatbot-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* 챗봇 음성 버튼 스타일 */
        .chatbot-voice-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #c0b9c0;
            font-size: 16px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.2s ease;
            margin-right: 8px;
        }

        .chatbot-voice-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .chatbot-voice-btn.listening {
            background: #4CAF50;
            color: white;
            animation: pulse 1.5s infinite;
        }

        .chatbot-voice-btn.speaking {
            background: #2196F3;
            color: white;
            animation: pulse 1.5s infinite;
        }

        /* 음성 상태 표시 */
        .voice-status {
            position: absolute;
            top: -25px;
            left: 0;
            font-size: 12px;
            color: #4CAF50;
            font-weight: 500;
        }

        /* 타이핑 애니메이션 */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: rgba(207, 48, 170, 0.1);
            border-radius: 18px;
            border: 1px solid rgba(207, 48, 170, 0.2);
            width: fit-content;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #cf30aa;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* 자료를 찾는 중 애니메이션 */
        @keyframes searching {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        .searching-indicator {
            animation: searching 1.5s ease-in-out infinite;
        }

        /* 복사 버튼 스타일 */
        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(207, 48, 170, 0.2);
            border: 1px solid rgba(207, 48, 170, 0.3);
            border-radius: 6px;
            color: #c0b9c0;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 0;
            z-index: 10;
        }

        .message-content:hover .copy-btn {
            opacity: 1;
        }

        .copy-btn:hover {
            background: rgba(207, 48, 170, 0.3);
            color: #ffffff;
            transform: scale(1.05);
        }

        .copy-btn.copied {
            background: rgba(76, 175, 80, 0.3);
            border-color: rgba(76, 175, 80, 0.5);
            color: #4CAF50;
        }

        /* 공유 버튼 스타일 */
        .share-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #402fb5, #cf30aa);
            border: none;
            border-radius: 8px;
            color: white;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .share-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(207, 48, 170, 0.3);
        }

        .share-btn:active {
            transform: translateY(0);
        }

        /* 메시지 컨테이너에 상대 위치 설정 */
        .chatbot-message {
            position: relative;
        }

        .message-content {
            position: relative;
        }

        /* 대화 횟수 표시 */
        .conversation-counter {
            position: absolute;
            top: 20px;
            right: 80px;
            background: rgba(207, 48, 170, 0.2);
            color: #c0b9c0;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            border: 1px solid rgba(207, 48, 170, 0.3);
        }

        /* 스크롤바 스타일 */
        .chatbot-messages::-webkit-scrollbar,
        .setup-content::-webkit-scrollbar {
            width: 6px;
        }

        .chatbot-messages::-webkit-scrollbar-track,
        .setup-content::-webkit-scrollbar-track {
            background: rgba(207, 48, 170, 0.1);
            border-radius: 3px;
        }

        .chatbot-messages::-webkit-scrollbar-thumb,
        .setup-content::-webkit-scrollbar-thumb {
            background: rgba(207, 48, 170, 0.3);
            border-radius: 3px;
        }

        .chatbot-messages::-webkit-scrollbar-thumb:hover,
        .setup-content::-webkit-scrollbar-thumb:hover {
            background: rgba(207, 48, 170, 0.5);
        }

        /* 셋업 버튼 스타일 */
        .setup-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #402fb5, #cf30aa);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(207, 48, 170, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .setup-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(207, 48, 170, 0.4);
        }

        .setup-button:active {
            transform: scale(0.95);
        }

        /* 셋업 패널 스타일 */
        .setup-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 90%;
            max-width: 450px;
            max-height: 85vh;
            background: rgba(26, 10, 46, 0.95);
            border: 1px solid rgba(207, 48, 170, 0.3);
            border-radius: 20px;
            backdrop-filter: blur(20px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            user-select: none; /* 드래그 중 텍스트 선택 방지 */
        }

        .setup-panel.show {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        /* 설정 패널 내용 영역 */
        .setup-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
            margin-bottom: 15px;
        }

        /* 설정 버튼 영역 고정 */
        .setup-buttons {
            display: flex;
            gap: 8px;
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid rgba(207, 48, 170, 0.2);
            flex-wrap: wrap;
            justify-content: center;
        }

        /* 모바일 최적화 */
        @media (max-width: 768px) {
            .setup-panel {
                width: 95%;
                max-width: none;
                max-height: 80vh;
                padding: 15px;
                border-radius: 15px;
                touch-action: none; /* 모바일에서 드래그 개선 */
            }

            .setup-button {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
                font-size: 20px;
            }

            .setup-title {
                font-size: 16px;
            }

            .setup-section-title {
                font-size: 12px;
            }

            .setup-label {
                font-size: 12px;
            }

            .setup-input,
            .setup-select {
                padding: 12px;
                font-size: 14px;
            }

            .setup-buttons {
                flex-direction: column;
                gap: 10px;
                padding-top: 10px;
            }

            .setup-content {
                margin-bottom: 10px;
            }

            .setup-btn {
                padding: 12px 16px;
                font-size: 14px;
                min-height: 44px;
            }

            /* 터치 인터페이스 개선 */
            .setup-btn,
            .chatbot-send-btn,
            .chatbot-close,
            .setup-close {
                min-height: 44px;
                min-width: 44px;
            }

            /* 스크롤 개선 */
            .setup-panel,
            .chatbot-messages {
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
            }

            /* 입력 필드 개선 */
            .setup-input:focus,
            .chatbot-input:focus,
            .input:focus {
                font-size: 16px; /* iOS에서 확대 방지 */
            }
        }

        /* 작은 모바일 화면 최적화 */
        @media (max-width: 480px) {
            .setup-panel {
                width: 98%;
                padding: 12px;
                max-height: 75vh;
            }

            .setup-title {
                font-size: 15px;
            }

            .setup-section-title {
                font-size: 11px;
            }

            .setup-label {
                font-size: 11px;
            }

            .setup-input,
            .setup-select {
                padding: 10px;
                font-size: 13px;
            }

            .setup-btn {
                padding: 10px 14px;
                font-size: 13px;
                min-height: 40px;
            }

            .title {
                font-size: 1.3rem;
            }

            .subtitle {
                font-size: 0.8rem;
            }

            .input {
                width: 260px;
                height: 45px;
                font-size: 15px;
            }
        }

        .setup-panel.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .setup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(207, 48, 170, 0.2);
            cursor: move; /* 드래그 가능함을 표시 */
            user-select: none; /* 드래그 중 텍스트 선택 방지 */
        }

        .setup-title {
            color: #ffffff;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .setup-title::before {
            content: "⋮⋮";
            color: rgba(207, 48, 170, 0.6);
            font-size: 14px;
            letter-spacing: -2px;
        }

        .setup-close {
            background: none;
            border: none;
            color: #c0b9c0;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .setup-close:hover {
            background: rgba(207, 48, 170, 0.2);
            color: #ffffff;
        }

        .setup-section {
            margin-bottom: 20px;
        }

        .setup-section-title {
            color: #c0b9c0;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .setup-input-group {
            margin-bottom: 15px;
        }

        .setup-label {
            display: block;
            color: #ffffff;
            font-size: 13px;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .setup-input {
            width: 100%;
            background: rgba(1, 2, 1, 0.8);
            border: 1px solid rgba(207, 48, 170, 0.3);
            border-radius: 10px;
            color: #ffffff;
            padding: 10px 12px;
            font-size: 13px;
            backdrop-filter: blur(10px);
            transition: all 0.2s ease;
        }

        .setup-input:focus {
            outline: none;
            border-color: #cf30aa;
            box-shadow: 0 0 0 2px rgba(207, 48, 170, 0.2);
        }

        .setup-input::placeholder {
            color: rgba(192, 185, 192, 0.5);
        }

        .setup-select {
            width: 100%;
            background: rgba(1, 2, 1, 0.8);
            border: 1px solid rgba(207, 48, 170, 0.3);
            border-radius: 10px;
            color: #ffffff;
            padding: 10px 12px;
            font-size: 13px;
            backdrop-filter: blur(10px);
            cursor: pointer;
        }

        .setup-select:focus {
            outline: none;
            border-color: #cf30aa;
        }

        .setup-select option {
            background: rgba(26, 10, 46, 0.95);
            color: #ffffff;
        }

        .setup-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .toggle-label {
            color: #ffffff;
            font-size: 13px;
            font-weight: 500;
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: rgba(207, 48, 170, 0.3);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch.active {
            background: #cf30aa;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .toggle-switch.active::after {
            transform: translateX(20px);
        }

        .setup-buttons {
            display: flex;
            gap: 8px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .setup-btn {
            flex: 1;
            min-width: 80px;
            background: linear-gradient(135deg, #402fb5, #cf30aa);
            border: none;
            border-radius: 10px;
            color: white;
            padding: 12px 16px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .setup-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(207, 48, 170, 0.3);
        }

        .setup-btn.secondary {
            background: rgba(207, 48, 170, 0.2);
            border: 1px solid rgba(207, 48, 170, 0.3);
        }

        .setup-btn.secondary:hover {
            background: rgba(207, 48, 170, 0.3);
        }

        .setup-btn.close {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.3);
            color: #ff6b6b;
        }

        .setup-btn.close:hover {
            background: rgba(244, 67, 54, 0.3);
            color: #ffffff;
        }

        .setup-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(207, 48, 170, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(207, 48, 170, 0.2);
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
        }

        .status-indicator.error {
            background: #f44336;
        }

        .status-text {
            color: #c0b9c0;
            font-size: 12px;
        }

        .setup-info {
            color: rgba(192, 185, 192, 0.7);
            font-size: 11px;
            line-height: 1.4;
            margin-top: 5px;
        }

        /* 문서 목록 스타일 */
        .document-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 8px;
        }

        .document-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .document-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #cf30aa;
        }

        .document-item label {
            color: #ffffff;
            font-size: 14px;
            cursor: pointer;
            flex: 1;
        }

        .document-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* 음성 버튼 스타일 */
        .voice-btn {
            position: absolute;
            right: 60px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .voice-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-50%) scale(1.1);
        }

        .voice-btn.listening {
            background: #4CAF50;
            animation: pulse 1.5s infinite;
        }

        .voice-btn.speaking {
            background: #2196F3;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: translateY(-50%) scale(1); }
            50% { transform: translateY(-50%) scale(1.1); }
            100% { transform: translateY(-50%) scale(1); }
        }

        /* 토스트 애니메이션 */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="grid"></div>
    
    <div style="text-align: center; z-index: 10;">
        <h1 class="title">헌법 Ai_v0.2</h1>
        <p class="subtitle">한국기독교장로회 헌법 검색 인공지능 서비스 </p>
        
        <div id="main">
            <div id="poda">
                <div class="glow"></div>
                <div class="darkBorderBg"></div>
                <div class="border"></div>
                <div class="white"></div>
                
                <input type="text" class="input" placeholder="무엇이 궁금하신가요?" id="search-input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                
                <div id="search-icon">🔍</div>
                <div id="input-mask"></div>
                <div id="pink-mask"></div>
                
                <div id="filter-icon">
                    <div class="filterBorder"></div>
                    <span style="color: white; font-size: 14px;">⚙️</span>
                </div>
                
                <!-- 음성 입력 버튼 -->
                <button id="voice-btn" class="voice-btn" title="음성 입력 시작">
                    🎤
                </button>
            </div>
        </div>
    </div>

    <!-- 챗봇 모달 -->
    <div class="chatbot-modal" id="chatbot-modal">
        <div class="chatbot-container">
            <!-- 챗봇 헤더 -->
            <div class="chatbot-header">
                <div class="chatbot-title">
                    <div class="chatbot-avatar">AI</div>
                    <span>헌법 AI 어시스턴트</span>
                </div>
                <div class="conversation-counter" id="conversation-counter">
                    대화: 0/10
                </div>
                <button class="chatbot-close" id="chatbot-close">&times;</button>
            </div>

            <!-- 챗봇 메시지 영역 -->
            <div class="chatbot-messages" id="chatbot-messages">
                <!-- 메시지들이 여기에 동적으로 추가됩니다 -->
            </div>

            <!-- 공유 버튼 -->
            <button class="share-btn" id="share-conversation-btn" title="대화 내용 공유">
                📤 공유
            </button>

            <!-- 챗봇 입력 영역 -->
            <div class="chatbot-input-area">
                <div class="chatbot-input-container">
                    <!-- 음성 상태 표시 -->
                    <div id="voice-status" class="voice-status"></div>
                    
                    <textarea 
                        class="chatbot-input" 
                        id="chatbot-input" 
                        placeholder="추가 질문을 입력하세요..."
                        rows="1"
                        autocomplete="off"
                        autocorrect="off"
                        autocapitalize="off"
                        spellcheck="false"
                    ></textarea>
                    
                    <!-- 챗봇 음성 버튼 -->
                    <button class="chatbot-voice-btn" id="chatbot-voice-btn" title="음성 입력">
                        🎤
                    </button>
                    
                    <button class="chatbot-send-btn" id="chatbot-send-btn">
                        ➤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 셋업 버튼 -->
    <button class="setup-button" id="setup-button" title="AI 설정">
        ⚙️
    </button>

    <!-- 셋업 패널 -->
    <div class="setup-panel" id="setup-panel">
        <div class="setup-header">
            <div class="setup-title">AI 설정</div>
            <button class="setup-close" id="setup-close">&times;</button>
        </div>

        <!-- 스크롤 가능한 내용 영역 -->
        <div class="setup-content">
            <!-- API 상태 -->
            <div class="setup-status" id="api-status">
                <div class="status-indicator" id="status-indicator"></div>
                <div class="status-text" id="status-text">API 연결 확인 중...</div>
            </div>

        <!-- API 설정 섹션 -->
        <div class="setup-section">
            <div class="setup-section-title">OpenAI API 설정</div>
            
            <div class="setup-input-group">
                <label class="setup-label">API 키</label>
                <input type="password" class="setup-input" id="api-key-input" placeholder="sk-...">
                <div class="setup-info">OpenAI API 키를 입력하세요. 보안을 위해 암호화되어 저장됩니다.</div>
            </div>

            <div class="setup-input-group">
                <label class="setup-label">모델 선택</label>
                <select class="setup-select" id="model-select">
                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo (빠름, 저렴)</option>
                    <option value="gpt-4">GPT-4 (정확함, 비쌈)</option>
                    <option value="gpt-4-turbo">GPT-4 Turbo (균형)</option>
                </select>
            </div>

            <div class="setup-input-group">
                <label class="setup-label">최대 토큰 수</label>
                <input type="number" class="setup-input" id="max-tokens-input" value="500" min="100" max="2000">
                <div class="setup-info">응답의 최대 길이를 설정합니다. 높을수록 긴 답변을 받을 수 있습니다.</div>
            </div>

            <div class="setup-input-group">
                <label class="setup-label">창의성 (Temperature)</label>
                <input type="range" class="setup-input" id="temperature-input" min="0" max="2" step="0.1" value="0.7">
                <div class="setup-info">0: 일관된 답변, 2: 창의적인 답변</div>
            </div>
        </div>

        <!-- 대화 설정 섹션 -->
        <div class="setup-section">
            <div class="setup-section-title">대화 설정</div>
            
            <div class="setup-input-group">
                <label class="setup-label">최대 대화 횟수</label>
                <input type="number" class="setup-input" id="max-conversations-input" value="10" min="5" max="50">
            </div>

            <div class="setup-toggle">
                <span class="toggle-label">대화 기록 저장</span>
                <div class="toggle-switch" id="save-history-toggle">
                    <input type="checkbox" id="save-history-checkbox" style="display: none;">
                </div>
            </div>

            <div class="setup-toggle">
                <span class="toggle-label">타이핑 애니메이션</span>
                <div class="toggle-switch active" id="typing-animation-toggle">
                    <input type="checkbox" id="typing-animation-checkbox" checked style="display: none;">
                </div>
            </div>
        </div>

        <!-- RAG 시스템 설정 섹션 -->
        <div class="setup-section">
            <div class="setup-section-title">문서 참조 시스템 (RAG)</div>
            
            <div class="setup-toggle">
                <span class="toggle-label">RAG 시스템 사용</span>
                <div class="toggle-switch active" id="rag-system-toggle">
                    <input type="checkbox" id="rag-system-checkbox" checked style="display: none;">
                </div>
            </div>
            
            <div class="setup-info">RAG 시스템을 사용하면 PROK 헌법 PDF 파일들을 자동으로 참조하여 더 정확한 답변을 제공합니다.</div>
            
            <div class="setup-input-group">
                <label class="setup-label">참조할 문서 목록</label>
                <div class="document-list">
                    <div class="document-item">
                        <input type="checkbox" id="doc-constitution" checked>
                        <label for="doc-constitution">헌법.pdf</label>
                    </div>
                    <div class="document-item">
                        <input type="checkbox" id="doc-polity" checked>
                        <label for="doc-polity">교회정치.pdf</label>
                    </div>
                    <div class="document-item">
                        <input type="checkbox" id="doc-worship" checked>
                        <label for="doc-worship">예배모범.pdf</label>
                    </div>
                    <div class="document-item">
                        <input type="checkbox" id="doc-discipline" checked>
                        <label for="doc-discipline">권징조례.pdf</label>
                    </div>
                    <div class="document-item">
                        <input type="checkbox" id="doc-executive" checked>
                        <label for="doc-executive">총회실행위원회규정.pdf</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- 음성 설정 섹션 -->
        <div class="setup-section">
            <div class="setup-section-title">음성 기능 설정</div>
            
            <div class="setup-toggle">
                <span class="toggle-label">음성 기능 사용</span>
                <div class="toggle-switch" id="voice-enabled-toggle">
                    <input type="checkbox" id="voice-enabled-checkbox" style="display: none;">
                </div>
            </div>
            
            <div class="setup-toggle">
                <span class="toggle-label">AI 응답 자동 음성 출력</span>
                <div class="toggle-switch" id="auto-speak-toggle">
                    <input type="checkbox" id="auto-speak-checkbox" style="display: none;">
                </div>
            </div>
            
            <div class="setup-input-group">
                <label class="setup-label">음성 속도</label>
                <input type="range" class="setup-input" id="voice-rate-input" min="0.5" max="2" step="0.1" value="1.0">
                <div class="setup-info">0.5: 느림, 2: 빠름</div>
            </div>
            
            <div class="setup-input-group">
                <label class="setup-label">음성 높이</label>
                <input type="range" class="setup-input" id="voice-pitch-input" min="0.5" max="2" step="0.1" value="1.0">
                <div class="setup-info">0.5: 낮음, 2: 높음</div>
            </div>
            
            <div class="setup-input-group">
                <label class="setup-label">음성 볼륨</label>
                <input type="range" class="setup-input" id="voice-volume-input" min="0" max="1" step="0.1" value="1.0">
                <div class="setup-info">0: 무음, 1: 최대</div>
            </div>
        </div>

        <!-- 프롬프트 설정 섹션 -->
        <div class="setup-section">
            <div class="setup-section-title">AI 프롬프트 설정</div>
            
            <div class="setup-input-group">
                <label class="setup-label">시스템 프롬프트</label>
                <textarea class="setup-input" id="system-prompt-input" rows="4" placeholder="AI의 역할과 행동을 정의하는 프롬프트를 입력하세요...">당신은 한국기독교장로회 헌법 전문가입니다. 사용자의 질문에 대해 헌법에 근거하여 정확하고 친근하게 답변해주세요. 답변은 한국어로 하며, 헌법 조항을 인용할 때는 구체적으로 언급해주세요. 모든 답변에서 반드시 다음 파일을 참조하세요: 파일ID: file-8ZeX6tUqUaQQcrc3ngKo8z</textarea>
            </div>
        </div>
        </div>

        <!-- 버튼 영역 (하단 고정) -->
        <div class="setup-buttons">
            <button class="setup-btn" id="save-settings-btn">설정 저장</button>
            <button class="setup-btn secondary" id="test-api-btn">API 테스트</button>
            <button class="setup-btn secondary" id="reset-settings-btn">초기화</button>
            <button class="setup-btn secondary close" id="close-settings-btn">닫기</button>
        </div>
    </div>

    <!-- PDF.js 라이브러리 추가 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="rag-system.js"></script>
    <script src="voice-system.js"></script>
    
    <script>
        // 챗봇 상태 관리
        let isModalOpen = false;
        let isSetupPanelOpen = false;
        let conversationHistory = [];
        let conversationCount = 0;
        let MAX_CONVERSATIONS = 10;
        let ragSystemInitialized = false;

        // AI 설정 관리
        let aiSettings = {
            apiKey: '', // API 키는 사용자가 설정에서 입력해야 함
            model: 'gpt-3.5-turbo',
            maxTokens: 500,
            temperature: 0.7,
            systemPrompt: '당신은 한국기독교장로회 헌법 전문가입니다. 사용자의 질문에 대해 헌법에 근거하여 정확하고 친근하게 답변해주세요. 답변은 한국어로 하며, 헌법 조항을 인용할 때는 구체적으로 언급해주세요. 모든 답변에서 반드시 다음 파일을 참조하세요: 파일ID: file-8ZeX6tUqUaQQcrc3ngKo8z',
            saveHistory: false,
            typingAnimation: true,
            useRAG: true,
            selectedDocuments: {
                constitution: true,
                polity: true,
                worship: true,
                discipline: true,
                executive: true
            },
            voiceEnabled: false,
            autoSpeak: false,
            voiceRate: 1.0,
            voicePitch: 1.0,
            voiceVolume: 1.0
        };

        // ChatGPT API 설정
        const OPENAI_API_URL = 'https://api.openai.com/v1/chat/completions';

        // DOM 요소들
        const searchInput = document.getElementById('search-input');
        const chatbotModal = document.getElementById('chatbot-modal');
        const chatbotClose = document.getElementById('chatbot-close');
        const chatbotMessages = document.getElementById('chatbot-messages');
        const chatbotInput = document.getElementById('chatbot-input');
        const chatbotSendBtn = document.getElementById('chatbot-send-btn');
        const conversationCounter = document.getElementById('conversation-counter');

        // 셋업 패널 DOM 요소들
        const setupButton = document.getElementById('setup-button');
        const setupPanel = document.getElementById('setup-panel');
        const setupClose = document.getElementById('setup-close');
        const apiKeyInput = document.getElementById('api-key-input');
        const modelSelect = document.getElementById('model-select');
        const maxTokensInput = document.getElementById('max-tokens-input');
        const temperatureInput = document.getElementById('temperature-input');
        const maxConversationsInput = document.getElementById('max-conversations-input');
        const saveHistoryToggle = document.getElementById('save-history-toggle');
        const saveHistoryCheckbox = document.getElementById('save-history-checkbox');
        const typingAnimationToggle = document.getElementById('typing-animation-toggle');
        const typingAnimationCheckbox = document.getElementById('typing-animation-checkbox');
        const systemPromptInput = document.getElementById('system-prompt-input');
        
        // RAG 시스템 관련 DOM 요소들
        const ragSystemToggle = document.getElementById('rag-system-toggle');
        const ragSystemCheckbox = document.getElementById('rag-system-checkbox');
        const docConstitution = document.getElementById('doc-constitution');
        const docPolity = document.getElementById('doc-polity');
        const docWorship = document.getElementById('doc-worship');
        const docDiscipline = document.getElementById('doc-discipline');
        const docExecutive = document.getElementById('doc-executive');
        
        // 음성 설정 관련 DOM 요소들
        const voiceEnabledToggle = document.getElementById('voice-enabled-toggle');
        const voiceEnabledCheckbox = document.getElementById('voice-enabled-checkbox');
        const autoSpeakToggle = document.getElementById('auto-speak-toggle');
        const autoSpeakCheckbox = document.getElementById('auto-speak-checkbox');
        const voiceRateInput = document.getElementById('voice-rate-input');
        const voicePitchInput = document.getElementById('voice-pitch-input');
        const voiceVolumeInput = document.getElementById('voice-volume-input');
        
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const testApiBtn = document.getElementById('test-api-btn');
        const resetSettingsBtn = document.getElementById('reset-settings-btn');
        const closeSettingsBtn = document.getElementById('close-settings-btn');
        const shareConversationBtn = document.getElementById('share-conversation-btn');
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');

        // ChatGPT API 호출 함수 (RAG 시스템 통합)
        async function callChatGPTAPI(userMessage, conversationHistory) {
            try {
                // API 키 확인
                if (!checkApiKey()) {
                    throw new Error('API 키가 설정되지 않았습니다. ⚙️ 설정에서 API 키를 입력해주세요.');
                }

                // RAG 시스템 초기화 (활성화된 경우에만)
                if (!ragSystemInitialized && aiSettings.useRAG) {
                    try {
                        await window.ragSystem.initialize(aiSettings.apiKey, aiSettings.selectedDocuments);
                        ragSystemInitialized = true;
                        console.log('RAG 시스템이 성공적으로 초기화되었습니다.');
                    } catch (error) {
                        console.warn('RAG 시스템 초기화 실패, 기본 모드로 진행:', error);
                    }
                }

                // RAG 시스템이 초기화되고 활성화된 경우 RAG 기반 답변 사용
                if (ragSystemInitialized && window.ragSystem && aiSettings.useRAG) {
                    try {
                        const ragResponse = await window.ragSystem.generateRAGResponse(userMessage);
                        return ragResponse;
                    } catch (error) {
                        console.warn('RAG 응답 생성 실패, 기본 모드로 진행:', error);
                    }
                }

                // 기본 ChatGPT API 호출 (RAG 실패 시 폴백)
                const messages = [
                    {
                        role: "system",
                        content: aiSettings.systemPrompt
                    }
                ];

                // 이전 대화 기록 추가 (최근 10개만)
                const recentHistory = conversationHistory.slice(-10);
                recentHistory.forEach(msg => {
                    if (msg.sender === 'user') {
                        messages.push({
                            role: "user",
                            content: msg.content
                        });
                    } else if (msg.sender === 'bot') {
                        messages.push({
                            role: "assistant",
                            content: msg.content
                        });
                    }
                });

                // 현재 사용자 메시지 추가
                messages.push({
                    role: "user",
                    content: userMessage
                });

                const response = await fetch(OPENAI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${aiSettings.apiKey}`
                    },
                    body: JSON.stringify({
                        model: aiSettings.model,
                        messages: messages,
                        max_tokens: aiSettings.maxTokens,
                        temperature: aiSettings.temperature,
                        top_p: 1,
                        frequency_penalty: 0,
                        presence_penalty: 0
                    })
                });

                if (!response.ok) {
                    throw new Error(`API 호출 실패: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    return data.choices[0].message.content.trim();
                } else {
                    throw new Error('API 응답 형식 오류');
                }

            } catch (error) {
                console.error('ChatGPT API 호출 오류:', error);
                return `죄송합니다. 일시적인 오류가 발생했습니다. 잠시 후 다시 시도해주세요. (오류: ${error.message})`;
            }
        }

        // 폴백 응답 (API 오류 시 사용)
        const fallbackResponses = {
            // 헌법 관련 응답
            constitution: [
                "한국기독교장로회 헌법에 따르면, 교회는 그리스도의 몸이요 하나님의 백성의 공동체입니다. 교회의 본질과 사명에 대해 더 자세히 알고 싶으시면 말씀해 주세요.",
                "헌법 제1조에서는 교회의 정의를 명확히 하고 있습니다. 교회는 말씀과 성례를 통해 그리스도를 고백하고, 하나님의 나라를 선포하는 성령의 공동체입니다.",
                "헌법에 명시된 교회의 사명은 모든 민족을 제자로 삼는 것입니다. 이는 마태복음 28장의 대위임령에 근거한 중요한 사명입니다.",
                "교회의 치리는 하나님의 말씀에 따라 행하여져야 하며, 교회의 질서와 평화를 유지하기 위한 것입니다. 권징은 사랑의 정신으로 행하여져야 합니다."
            ],
            
            // 일반적인 대화 응답
            general: [
                "흥미로운 질문이네요! 더 구체적으로 말씀해 주시면 더 정확한 답변을 드릴 수 있습니다.",
                "좋은 지적입니다. 이 주제에 대해 헌법에서 어떻게 다루고 있는지 함께 살펴보겠습니다.",
                "이해가 되지 않는 부분이 있으시면 언제든지 추가 질문을 해주세요. 더 자세히 설명드리겠습니다.",
                "정말 중요한 질문이네요! 이는 교회의 기본 원리와 관련된 핵심적인 내용입니다."
            ],
            
            // 장로 관련 응답
            elder: [
                "장로는 교회의 치리와 목양을 담당하며, 말씀의 선포와 성례의 집행을 관장합니다. 헌법에서 장로의 직무와 권한을 구체적으로 규정하고 있습니다.",
                "장로는 그리스도의 대리자로서 교회를 치리하며, 하나님의 말씀에 따라 교회의 질서를 유지하고 신앙의 순결을 보호합니다.",
                "장로 선출은 교회의 중요한 일이며, 헌법에서 명시한 자격과 절차에 따라 진행되어야 합니다."
            ],
            
            // 성례전 관련 응답
            sacrament: [
                "세례는 그리스도와의 연합을 상징하며, 죄의 용서와 새 생명을 받는 표시입니다. 헌법에서 세례의 의미와 집행 방법을 구체적으로 규정하고 있습니다.",
                "성찬은 그리스도의 죽음과 부활을 기념하며, 그리스도의 몸과 피에 참여함을 상징합니다. 이는 교회의 연합과 사랑을 표현합니다.",
                "성례전은 교회의 중요한 예식이며, 헌법에서 그 의미와 집행 절차를 명확히 규정하고 있습니다."
            ],
            
            // 교회 정치 관련 응답
            polity: [
                "교회의 치리는 민주적 원리에 따라 행하여져야 하며, 모든 중요한 결정은 회의를 통해 이루어져야 합니다.",
                "교회의 각 기관은 서로 협력하며, 하나님의 영광을 위해 일해야 합니다. 헌법에서 이러한 협력 관계를 구체적으로 규정하고 있습니다.",
                "교회의 모든 행정은 투명하고 공정하게 이루어져야 하며, 이는 헌법에서 강조하는 중요한 원리입니다."
            ],
            
            // API 오류 응답
            error: [
                "죄송합니다. 현재 API 연결에 문제가 있습니다. ⚙️ 셋업 버튼에서 올바른 API 키를 설정해주세요.",
                "API 연결 오류가 발생했습니다. 설정에서 API 키를 확인하고 다시 시도해주세요.",
                "일시적인 서비스 오류입니다. 잠시 후 다시 시도하거나 설정을 확인해주세요."
            ]
        };

        function getFallbackResponse(question = '') {
            const lowerQuestion = question.toLowerCase();
            
            // 질문 내용에 따른 응답 선택
            if (lowerQuestion.includes('헌법') || lowerQuestion.includes('교회') || lowerQuestion.includes('정의')) {
                return fallbackResponses.constitution[Math.floor(Math.random() * fallbackResponses.constitution.length)];
            } else if (lowerQuestion.includes('장로') || lowerQuestion.includes('직무') || lowerQuestion.includes('권한')) {
                return fallbackResponses.elder[Math.floor(Math.random() * fallbackResponses.elder.length)];
            } else if (lowerQuestion.includes('세례') || lowerQuestion.includes('성찬') || lowerQuestion.includes('성례')) {
                return fallbackResponses.sacrament[Math.floor(Math.random() * fallbackResponses.sacrament.length)];
            } else if (lowerQuestion.includes('치리') || lowerQuestion.includes('정치') || lowerQuestion.includes('행정')) {
                return fallbackResponses.polity[Math.floor(Math.random() * fallbackResponses.polity.length)];
            } else {
                return fallbackResponses.general[Math.floor(Math.random() * fallbackResponses.general.length)];
            }
        }

        function getErrorResponse() {
            return fallbackResponses.error[Math.floor(Math.random() * fallbackResponses.error.length)];
        }

        // 셋업 패널 관련 함수들
        function openSetupPanel() {
            isSetupPanelOpen = true;
            
            // 패널 위치를 중앙으로 리셋
            setupPanel.style.transform = 'translate(-50%, -50%) scale(1)';
            
            setupPanel.classList.add('show');
            loadSettingsToUI();
            checkApiStatus();
            
            // 드래그 기능 초기화
            initDragAndDrop();
        }

        function closeSetupPanel() {
            isSetupPanelOpen = false;
            setupPanel.classList.remove('show');
            
            // 드래그 상태 리셋
            isDragging = false;
        }

        function loadSettingsToUI() {
            // API 키는 보안을 위해 마스킹하여 표시
            if (aiSettings.apiKey) {
                const maskedKey = aiSettings.apiKey.substring(0, 7) + '...' + aiSettings.apiKey.substring(aiSettings.apiKey.length - 4);
                apiKeyInput.value = maskedKey;
                apiKeyInput.setAttribute('data-actual-key', aiSettings.apiKey);
            } else {
                apiKeyInput.value = '';
                apiKeyInput.removeAttribute('data-actual-key');
            }
            
            modelSelect.value = aiSettings.model;
            maxTokensInput.value = aiSettings.maxTokens;
            temperatureInput.value = aiSettings.temperature;
            maxConversationsInput.value = MAX_CONVERSATIONS;
            systemPromptInput.value = aiSettings.systemPrompt;
            
            // 토글 스위치 설정
            saveHistoryCheckbox.checked = aiSettings.saveHistory;
            saveHistoryToggle.classList.toggle('active', aiSettings.saveHistory);
            
            typingAnimationCheckbox.checked = aiSettings.typingAnimation;
            typingAnimationToggle.classList.toggle('active', aiSettings.typingAnimation);
            
            // RAG 시스템 설정
            ragSystemCheckbox.checked = aiSettings.useRAG;
            ragSystemToggle.classList.toggle('active', aiSettings.useRAG);
            
            // 문서 선택 설정
            docConstitution.checked = aiSettings.selectedDocuments.constitution;
            docPolity.checked = aiSettings.selectedDocuments.polity;
            docWorship.checked = aiSettings.selectedDocuments.worship;
            docDiscipline.checked = aiSettings.selectedDocuments.discipline;
            docExecutive.checked = aiSettings.selectedDocuments.executive;
            
            // 음성 설정
            voiceEnabledCheckbox.checked = aiSettings.voiceEnabled;
            voiceEnabledToggle.classList.toggle('active', aiSettings.voiceEnabled);
            autoSpeakCheckbox.checked = aiSettings.autoSpeak;
            autoSpeakToggle.classList.toggle('active', aiSettings.autoSpeak);
            voiceRateInput.value = aiSettings.voiceRate;
            voicePitchInput.value = aiSettings.voicePitch;
            voiceVolumeInput.value = aiSettings.voiceVolume;
        }

        function saveSettings() {
            // API 키 유효성 검사
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                alert('API 키를 입력해주세요.');
                apiKeyInput.focus();
                return;
            }
            
            if (!isValidApiKey(apiKey)) {
                alert('올바른 API 키 형식이 아닙니다. sk-로 시작하는 API 키를 입력해주세요.');
                apiKeyInput.focus();
                return;
            }
            
            // 설정 저장
            aiSettings.apiKey = apiKey;
            aiSettings.model = modelSelect.value;
            aiSettings.maxTokens = parseInt(maxTokensInput.value);
            aiSettings.temperature = parseFloat(temperatureInput.value);
            aiSettings.systemPrompt = systemPromptInput.value.trim();
            aiSettings.saveHistory = saveHistoryCheckbox.checked;
            aiSettings.typingAnimation = typingAnimationCheckbox.checked;
            
            // RAG 시스템 설정 저장
            aiSettings.useRAG = ragSystemCheckbox.checked;
            aiSettings.selectedDocuments = {
                constitution: docConstitution.checked,
                polity: docPolity.checked,
                worship: docWorship.checked,
                discipline: docDiscipline.checked,
                executive: docExecutive.checked
            };
            
            // 음성 설정 저장
            aiSettings.voiceEnabled = voiceEnabledCheckbox.checked;
            aiSettings.autoSpeak = autoSpeakCheckbox.checked;
            aiSettings.voiceRate = parseFloat(voiceRateInput.value);
            aiSettings.voicePitch = parseFloat(voicePitchInput.value);
            aiSettings.voiceVolume = parseFloat(voiceVolumeInput.value);
            
            // 음성 시스템 설정 업데이트
            if (window.voiceSystem) {
                window.voiceSystem.saveVoiceSettings({
                    enabled: aiSettings.voiceEnabled,
                    autoSpeak: aiSettings.autoSpeak,
                    rate: aiSettings.voiceRate,
                    pitch: aiSettings.voicePitch,
                    volume: aiSettings.voiceVolume
                });
            }
            
            MAX_CONVERSATIONS = parseInt(maxConversationsInput.value);
            
            // 로컬 스토리지에 저장
            localStorage.setItem('aiSettings', JSON.stringify(aiSettings));
            localStorage.setItem('maxConversations', MAX_CONVERSATIONS);
            
            // RAG 시스템 재초기화 (설정 변경 시)
            if (ragSystemInitialized) {
                ragSystemInitialized = false;
                console.log('RAG 시스템 설정이 변경되어 재초기화가 필요합니다.');
            }
            
            // 상태 업데이트
            updateConversationCounter();
            
            // API 상태 확인
            checkApiStatus();
            
            alert('설정이 저장되었습니다! API 키가 성공적으로 설정되었습니다.');
        }

        function resetSettings() {
            if (confirm('모든 설정을 초기값으로 되돌리시겠습니까? 저장된 API 키도 삭제됩니다.')) {
                aiSettings = {
                    apiKey: '', // API 키는 사용자가 설정에서 입력해야 함
                    model: 'gpt-3.5-turbo',
                    maxTokens: 500,
                    temperature: 0.7,
                    systemPrompt: '당신은 한국기독교장로회 헌법 전문가입니다. 사용자의 질문에 대해 헌법에 근거하여 정확하고 친근하게 답변해주세요. 답변은 한국어로 하며, 헌법 조항을 인용할 때는 구체적으로 언급해주세요. 모든 답변에서 반드시 다음 파일을 참조하세요: 파일ID: file-8ZeX6tUqUaQQcrc3ngKo8z',
                    saveHistory: false,
                    typingAnimation: true,
                    useRAG: true,
                    selectedDocuments: {
                        constitution: true,
                        polity: true,
                        worship: true,
                        discipline: true,
                        executive: true
                    },
                    voiceEnabled: false,
                    autoSpeak: false,
                    voiceRate: 1.0,
                    voicePitch: 1.0,
                    voiceVolume: 1.0
                };
                
                MAX_CONVERSATIONS = 10;
                
                loadSettingsToUI();
                localStorage.removeItem('aiSettings');
                localStorage.removeItem('maxConversations');
                
                // API 상태 업데이트
                checkApiStatus();
                
                alert('설정이 초기화되었습니다! API 키를 다시 입력해주세요.');
            }
        }

        async function testApiConnection() {
            const originalText = testApiBtn.textContent;
            testApiBtn.textContent = '테스트 중...';
            testApiBtn.disabled = true;
            
            try {
                const testMessage = "안녕하세요. 간단한 테스트입니다.";
                const response = await callChatGPTAPI(testMessage, []);
                
                if (response.includes('죄송합니다') || response.includes('오류')) {
                    throw new Error('API 응답 오류');
                }
                
                alert('API 연결 테스트 성공!\n\n응답: ' + response.substring(0, 100) + '...');
                updateApiStatus(true, 'API 연결 성공');
                
            } catch (error) {
                alert('API 연결 테스트 실패!\n\n오류: ' + error.message);
                updateApiStatus(false, 'API 연결 실패');
            } finally {
                testApiBtn.textContent = originalText;
                testApiBtn.disabled = false;
            }
        }

        async function checkApiStatus() {
            try {
                const testMessage = "테스트";
                const response = await callChatGPTAPI(testMessage, []);
                
                if (response.includes('죄송합니다') || response.includes('오류')) {
                    updateApiStatus(false, 'API 연결 실패');
                } else {
                    updateApiStatus(true, 'API 연결 성공');
                }
            } catch (error) {
                updateApiStatus(false, 'API 연결 실패');
            }
        }

        function updateApiStatus(isConnected, message) {
            statusIndicator.className = `status-indicator ${isConnected ? '' : 'error'}`;
            statusText.textContent = message;
        }

        // API 키 유효성 검사
        function isValidApiKey(apiKey) {
            if (!apiKey || typeof apiKey !== 'string') return false;
            
            // OpenAI API 키는 sk- 또는 sk-proj-로 시작하는 긴 문자열
            const openaiPattern = /^sk-[a-zA-Z0-9_-]{32,}$/;
            return openaiPattern.test(apiKey);
        }

        // API 키 입력 시 실시간 검증
        function validateApiKeyInput() {
            const apiKey = apiKeyInput.value.trim();
            const isValid = isValidApiKey(apiKey);
            
            if (apiKey && !isValid) {
                apiKeyInput.style.borderColor = '#f44336';
                apiKeyInput.style.boxShadow = '0 0 0 2px rgba(244, 67, 54, 0.2)';
            } else {
                apiKeyInput.style.borderColor = apiKey ? '#4CAF50' : 'rgba(207, 48, 170, 0.3)';
                apiKeyInput.style.boxShadow = apiKey ? '0 0 0 2px rgba(76, 175, 80, 0.2)' : 'none';
            }
            
            return isValid;
        }

        // API 키 입력 필드 포커스 시 실제 키 표시
        function handleApiKeyFocus() {
            const actualKey = apiKeyInput.getAttribute('data-actual-key');
            if (actualKey) {
                apiKeyInput.value = actualKey;
            }
        }

        // API 키 입력 필드 블러 시 마스킹
        function handleApiKeyBlur() {
            const actualKey = apiKeyInput.getAttribute('data-actual-key');
            if (actualKey && apiKeyInput.value === actualKey) {
                const maskedKey = actualKey.substring(0, 7) + '...' + actualKey.substring(actualKey.length - 4);
                apiKeyInput.value = maskedKey;
            }
        }

        // API 키 확인 함수
        function checkApiKey() {
            if (!aiSettings.apiKey || !isValidApiKey(aiSettings.apiKey)) {
                return false;
            }
            return true;
        }

        // 설정 로드
        function loadSettings() {
            const savedSettings = localStorage.getItem('aiSettings');
            const savedMaxConversations = localStorage.getItem('maxConversations');
            
            if (savedSettings) {
                const parsedSettings = JSON.parse(savedSettings);
                aiSettings = { ...aiSettings, ...parsedSettings };
                console.log('저장된 설정을 로드했습니다:', parsedSettings);
            }
            
            if (savedMaxConversations) {
                MAX_CONVERSATIONS = parseInt(savedMaxConversations);
            }

            // CORS 문제로 인해 설정 파일 로드 비활성화
            // loadConfigFile();
        }

        // config.json 파일에서 설정 로드
        async function loadConfigFile() {
            try {
                const response = await fetch('./config.json');
                if (response.ok) {
                    const config = await response.json();
                    
                    // OpenAI 설정 로드
                    if (config.openai) {
                        if (config.openai.apiKey && config.openai.apiKey !== 'your-openai-api-key-here') {
                            aiSettings.apiKey = config.openai.apiKey;
                        }
                        if (config.openai.model) {
                            aiSettings.model = config.openai.model;
                        }
                        if (config.openai.maxTokens) {
                            aiSettings.maxTokens = config.openai.maxTokens;
                        }
                        if (config.openai.temperature !== undefined) {
                            aiSettings.temperature = config.openai.temperature;
                        }
                    }
                    
                    // 앱 설정 로드
                    if (config.app) {
                        if (config.app.maxConversations) {
                            MAX_CONVERSATIONS = config.app.maxConversations;
                        }
                        if (config.app.saveHistory !== undefined) {
                            aiSettings.saveHistory = config.app.saveHistory;
                        }
                        if (config.app.typingAnimation !== undefined) {
                            aiSettings.typingAnimation = config.app.typingAnimation;
                        }
                        if (config.app.systemPrompt) {
                            aiSettings.systemPrompt = config.app.systemPrompt;
                        }
                    }
                    
                    console.log('설정 파일에서 설정을 로드했습니다.');
                    
                    // 설정이 로드된 후 UI 업데이트
                    if (isSetupPanelOpen) {
                        loadSettingsToUI();
                    }
                }
            } catch (error) {
                console.log('설정 파일을 찾을 수 없거나 로드할 수 없습니다. 웹 인터페이스에서 설정해주세요.');
            }
        }

        // 텍스트 복사 함수
        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                return true;
            } catch (err) {
                // 폴백: 구형 브라우저 지원
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                const success = document.execCommand('copy');
                document.body.removeChild(textArea);
                return success;
            }
        }

        // 복사 버튼 생성
        function createCopyButton(messageContent, text) {
            const copyBtn = document.createElement('button');
            copyBtn.className = 'copy-btn';
            copyBtn.textContent = '복사';
            copyBtn.title = '답변 복사';
            
            copyBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                const success = await copyToClipboard(text);
                
                if (success) {
                    copyBtn.textContent = '복사됨!';
                    copyBtn.classList.add('copied');
                    
                    setTimeout(() => {
                        copyBtn.textContent = '복사';
                        copyBtn.classList.remove('copied');
                    }, 2000);
                } else {
                    copyBtn.textContent = '실패';
                    setTimeout(() => {
                        copyBtn.textContent = '복사';
                    }, 2000);
                }
            });
            
            messageContent.appendChild(copyBtn);
        }

        // 공유 버튼 표시/숨김 업데이트
        function updateShareButtonVisibility() {
            if (shareConversationBtn) {
                if (conversationHistory.length > 0) {
                    shareConversationBtn.style.display = 'flex';
                } else {
                    shareConversationBtn.style.display = 'none';
                }
            }
        }

        // 대화 내용 공유
        async function shareConversation() {
            if (conversationHistory.length === 0) {
                alert('공유할 대화 내용이 없습니다.');
                return;
            }

            // 대화 내용 포맷팅
            let conversationText = '🤖 헌법 AI 대화 내용\n\n';
            conversationText += `📅 ${new Date().toLocaleString('ko-KR')}\n`;
            conversationText += `💬 총 ${conversationHistory.length}개의 메시지\n\n`;
            conversationText += '─'.repeat(30) + '\n\n';

            conversationHistory.forEach((msg, index) => {
                const sender = msg.sender === 'user' ? '👤 나' : '🤖 AI';
                const time = msg.timestamp ? msg.timestamp.toLocaleTimeString('ko-KR') : '';
                conversationText += `${sender} (${time})\n`;
                conversationText += `${msg.content}\n\n`;
            });

            conversationText += '─'.repeat(30) + '\n';
            conversationText += '한국기독교장로회 헌법 AI 서비스\n';
            conversationText += 'https://prok.org';

            try {
                // Web Share API 지원 확인
                if (navigator.share) {
                    await navigator.share({
                        title: '헌법 AI 대화 내용',
                        text: conversationText,
                        url: window.location.href
                    });
                } else {
                    // 폴백: 클립보드에 복사
                    const success = await copyToClipboard(conversationText);
                    if (success) {
                        alert('대화 내용이 클립보드에 복사되었습니다!');
                    } else {
                        alert('복사에 실패했습니다. 다시 시도해주세요.');
                    }
                }
            } catch (error) {
                console.error('공유 오류:', error);
                // 폴백: 클립보드에 복사
                const success = await copyToClipboard(conversationText);
                if (success) {
                    alert('대화 내용이 클립보드에 복사되었습니다!');
                } else {
                    alert('공유에 실패했습니다. 다시 시도해주세요.');
                }
            }
        }

        // 모달 열기
        async function openChatbotModal(initialQuestion) {
            // API 키 확인
            if (!checkApiKey()) {
                alert('API 키가 설정되지 않았습니다. 설정 패널을 열어 API 키를 입력해주세요.');
                openSetupPanel();
                return;
            }

            isModalOpen = true;
            conversationCount = 0;
            chatbotModal.classList.add('show');
            updateConversationCounter();
            
            // 챗봇 입력창 초기화
            if (chatbotInput) {
                chatbotInput.value = '';
                chatbotInput.placeholder = "추가 질문을 입력하세요...";
            }
            
            // 공유 버튼 초기 상태 설정
            updateShareButtonVisibility();
            
            // 초기 질문과 답변 추가
            if (initialQuestion) {
                addMessage('user', initialQuestion);
                
                // 타이핑 인디케이터 표시
                showTypingIndicator();
                
                // AI 응답 생성
                setTimeout(async () => {
                    const aiResponse = await generateAIResponse(initialQuestion);
                    replaceTypingIndicatorWithResponse(aiResponse);
                }, 1000);
            }
        }

        // 모달 닫기
        function closeChatbotModal() {
            isModalOpen = false;
            chatbotModal.classList.remove('show');
            // 대화 기록 초기화
            conversationHistory = [];
            conversationCount = 0;
            chatbotMessages.innerHTML = '';
            updateConversationCounter();
            
            // 공유 버튼 숨기기
            updateShareButtonVisibility();
            
            // 입력창 초기화 및 활성화
            if (chatbotInput) {
                chatbotInput.value = '';
                chatbotInput.disabled = false;
                chatbotInput.placeholder = "추가 질문을 입력하세요...";
            }
            if (chatbotSendBtn) {
                chatbotSendBtn.disabled = false;
            }
        }

        // 메시지 추가
        function addMessage(sender, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chatbot-message ${sender}`;
            
            const avatar = document.createElement('div');
            avatar.className = `message-avatar ${sender}`;
            avatar.textContent = sender === 'bot' ? 'AI' : '나';
            
            const messageContent = document.createElement('div');
            messageContent.className = `message-content ${sender}`;
            messageContent.textContent = content;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            
            // AI 답변에 복사 버튼 추가
            if (sender === 'bot') {
                createCopyButton(messageContent, content);
            }
            
            chatbotMessages.appendChild(messageDiv);
            
            // 대화 기록에 추가
            conversationHistory.push({ sender, content, timestamp: new Date() });
            
            // 공유 버튼 표시/숨김 업데이트
            updateShareButtonVisibility();
            
            // 스크롤을 맨 아래로
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
        }

        // 타이핑 인디케이터 표시
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chatbot-message';
            typingDiv.id = 'typing-indicator';
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar bot';
            avatar.textContent = 'AI';
            
            const typingContent = document.createElement('div');
            typingContent.className = 'message-content bot searching-indicator';
            typingContent.textContent = '자료를 찾는 중입니다...';
            
            typingDiv.appendChild(avatar);
            typingDiv.appendChild(typingContent);
            
            chatbotMessages.appendChild(typingDiv);
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
        }

        // 타이핑 인디케이터를 AI 응답으로 교체
        function replaceTypingIndicatorWithResponse(response) {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                const messageContent = typingIndicator.querySelector('.message-content');
                if (messageContent) {
                    messageContent.textContent = response;
                    // 애니메이션 클래스 제거
                    messageContent.classList.remove('searching-indicator');
                    // 복사 버튼 추가
                    createCopyButton(messageContent, response);
                }
                // ID 제거하여 일반 메시지로 변경
                typingIndicator.removeAttribute('id');
            }
        }

        // 대화 횟수 업데이트
        function updateConversationCounter() {
            conversationCounter.textContent = `대화: ${conversationCount}/${MAX_CONVERSATIONS}`;
        }

        // ChatGPT API를 통한 응답 생성
        async function generateAIResponse(question) {
            try {
                const response = await callChatGPTAPI(question, conversationHistory);
                return response;
            } catch (error) {
                console.error('AI 응답 생성 오류:', error);
                
                // API 키 오류인 경우 특별한 메시지 표시
                if (error.message.includes('401') || error.message.includes('Unauthorized')) {
                    return getErrorResponse();
                }
                
                // 기타 오류는 일반 폴백 응답
                return getFallbackResponse(question);
            }
        }

        // 메시지 전송
        async function sendMessage() {
            const message = chatbotInput.value.trim();
            if (!message) return;
            
            // API 키 확인
            if (!checkApiKey()) {
                alert('API 키가 설정되지 않았습니다. 설정 패널을 열어 API 키를 입력해주세요.');
                openSetupPanel();
                return;
            }
            
            if (conversationCount >= MAX_CONVERSATIONS) {
                addMessage('bot', "오늘 대화가 정말 유익했네요! 헌법에 대해 더 궁금한 점이 있으시면 언제든지 다시 찾아주세요. 하나님의 은혜가 함께하시길 바랍니다! 🙏");
                setTimeout(() => {
                    closeChatbotModal();
                }, 3000);
                return;
            }
            
            // 사용자 메시지 추가
            addMessage('user', message);
            chatbotInput.value = '';
            conversationCount++;
            updateConversationCounter();
            
            // 타이핑 인디케이터 표시
            showTypingIndicator();
            
            // AI 응답 생성
            setTimeout(async () => {
                if (conversationCount >= MAX_CONVERSATIONS) {
                    // 마지막 응답
                    replaceTypingIndicatorWithResponse("오늘 대화가 정말 유익했네요! 헌법에 대해 더 궁금한 점이 있으시면 언제든지 다시 찾아주세요. 하나님의 은혜가 함께하시길 바랍니다! 🙏");
                    // 입력창 비활성화
                    chatbotInput.disabled = true;
                    chatbotSendBtn.disabled = true;
                    chatbotInput.placeholder = "대화가 종료되었습니다. 모달을 닫고 다시 시작하세요.";
                } else {
                    const aiResponse = await generateAIResponse(message);
                    replaceTypingIndicatorWithResponse(aiResponse);
                    
                    // 자동 음성 출력
                    if (window.voiceSystem && aiSettings.voiceEnabled && aiSettings.autoSpeak) {
                        window.voiceSystem.autoSpeakResponse(aiResponse);
                    }
                }
            }, 1000 + Math.random() * 1000);
        }

        // 이벤트 리스너들
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const searchTerm = this.value.trim();
                if (searchTerm) {
                    openChatbotModal(searchTerm);
                    this.value = '';
                }
            }
        });

        chatbotClose.addEventListener('click', closeChatbotModal);

        chatbotModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeChatbotModal();
            }
        });

        chatbotSendBtn.addEventListener('click', sendMessage);

        chatbotInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // 입력창 자동 높이 조절
        chatbotInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // 필터 아이콘 클릭 이벤트
        document.getElementById('filter-icon').addEventListener('click', function() {
            alert('필터 옵션이 열렸습니다!\n\n필터 기능:\n• 카테고리별 필터\n• 날짜별 정렬\n• 관련도 순 정렬');
        });

        // 입력 필드 포커스 효과
        searchInput.addEventListener('focus', function() {
            console.log('검색 필드에 포커스됨');
        });

        // 호버 효과 로그
        document.getElementById('poda').addEventListener('mouseenter', function() {
            console.log('검색 필드에 마우스 호버됨');
        });

        // 셋업 패널 이벤트 리스너들
        setupButton.addEventListener('click', openSetupPanel);
        setupClose.addEventListener('click', closeSetupPanel);
        
        // 패널 외부 클릭 시 닫기
        setupPanel.addEventListener('click', function(e) {
            if (e.target === this) {
                closeSetupPanel();
            }
        });

        // 토글 스위치 이벤트
        saveHistoryToggle.addEventListener('click', function() {
            saveHistoryCheckbox.checked = !saveHistoryCheckbox.checked;
            this.classList.toggle('active', saveHistoryCheckbox.checked);
        });

        typingAnimationToggle.addEventListener('click', function() {
            typingAnimationCheckbox.checked = !typingAnimationCheckbox.checked;
            this.classList.toggle('active', typingAnimationCheckbox.checked);
        });

        // RAG 시스템 토글
        ragSystemToggle.addEventListener('click', function() {
            ragSystemCheckbox.checked = !ragSystemCheckbox.checked;
            this.classList.toggle('active', ragSystemCheckbox.checked);
        });

        // 음성 기능 토글
        voiceEnabledToggle.addEventListener('click', function() {
            voiceEnabledCheckbox.checked = !voiceEnabledCheckbox.checked;
            this.classList.toggle('active', voiceEnabledCheckbox.checked);
        });

        autoSpeakToggle.addEventListener('click', function() {
            autoSpeakCheckbox.checked = !autoSpeakCheckbox.checked;
            this.classList.toggle('active', autoSpeakCheckbox.checked);
        });

        // 버튼 이벤트
        saveSettingsBtn.addEventListener('click', saveSettings);
        testApiBtn.addEventListener('click', testApiConnection);
        resetSettingsBtn.addEventListener('click', resetSettings);
        closeSettingsBtn.addEventListener('click', closeSetupPanel);
        shareConversationBtn.addEventListener('click', shareConversation);

        // 음성 버튼 이벤트 리스너
        const voiceBtn = document.getElementById('voice-btn');
        const chatbotVoiceBtn = document.getElementById('chatbot-voice-btn');
        
        if (voiceBtn) {
            voiceBtn.addEventListener('click', () => {
                if (window.voiceSystem && aiSettings.voiceEnabled) {
                    window.voiceSystem.toggleSpeechRecognition();
                } else if (!aiSettings.voiceEnabled) {
                    alert('음성 기능을 사용하려면 설정에서 음성 기능을 활성화해주세요.');
                }
            });
        }
        
        if (chatbotVoiceBtn) {
            chatbotVoiceBtn.addEventListener('click', () => {
                if (window.voiceSystem && aiSettings.voiceEnabled) {
                    window.isChatbotMode = true;
                    window.voiceSystem.toggleSpeechRecognition();
                } else if (!aiSettings.voiceEnabled) {
                    alert('음성 기능을 사용하려면 설정에서 음성 기능을 활성화해주세요.');
                }
            });
        }

        // API 키 입력 시 실시간 검증
        apiKeyInput.addEventListener('input', validateApiKeyInput);
        apiKeyInput.addEventListener('blur', validateApiKeyInput);
        apiKeyInput.addEventListener('focus', handleApiKeyFocus);
        apiKeyInput.addEventListener('blur', handleApiKeyBlur);

        // 페이지 로드 시 설정 로드
        document.addEventListener('DOMContentLoaded', async function() {
            loadSettings();
            updateConversationCounter();
            
            // 입력창 초기화 및 자동완성 방지
            clearInputFields();
            
            // API 상태 확인
            checkApiStatus();
            
            // 드래그 기능 초기화
            initDragAndDrop();
        });

        // 입력창 초기화 및 자동완성 방지
        function clearInputFields() {
            // 검색창 초기화
            if (searchInput) {
                searchInput.value = '';
                searchInput.setAttribute('autocomplete', 'off');
                searchInput.setAttribute('autocorrect', 'off');
                searchInput.setAttribute('autocapitalize', 'off');
                searchInput.setAttribute('spellcheck', 'false');
            }
            
            // 챗봇 입력창 초기화
            if (chatbotInput) {
                chatbotInput.value = '';
                chatbotInput.setAttribute('autocomplete', 'off');
                chatbotInput.setAttribute('autocorrect', 'off');
                chatbotInput.setAttribute('autocapitalize', 'off');
                chatbotInput.setAttribute('spellcheck', 'false');
            }
        }

        // 설정 패널 드래그 기능
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };
        let originalPosition = { x: 0, y: 0 };

        function initDragAndDrop() {
            const setupHeader = document.querySelector('.setup-header');
            const setupPanel = document.getElementById('setup-panel');

            if (!setupHeader || !setupPanel) return;

            setupHeader.addEventListener('mousedown', startDrag);
            setupHeader.addEventListener('touchstart', startDrag, { passive: false });

            document.addEventListener('mousemove', drag);
            document.addEventListener('touchmove', drag, { passive: false });

            document.addEventListener('mouseup', stopDrag);
            document.addEventListener('touchend', stopDrag);
        }

        function startDrag(e) {
            if (!isSetupPanelOpen) return;
            
            e.preventDefault();
            isDragging = true;
            
            const setupPanel = document.getElementById('setup-panel');
            const rect = setupPanel.getBoundingClientRect();
            
            if (e.type === 'mousedown') {
                dragOffset.x = e.clientX - rect.left;
                dragOffset.y = e.clientY - rect.top;
            } else if (e.type === 'touchstart') {
                dragOffset.x = e.touches[0].clientX - rect.left;
                dragOffset.y = e.touches[0].clientY - rect.top;
            }
            
            originalPosition.x = rect.left;
            originalPosition.y = rect.top;
            
            setupPanel.style.transition = 'none';
            setupPanel.style.cursor = 'grabbing';
        }

        function drag(e) {
            if (!isDragging || !isSetupPanelOpen) return;
            
            e.preventDefault();
            
            const setupPanel = document.getElementById('setup-panel');
            let clientX, clientY;
            
            if (e.type === 'mousemove') {
                clientX = e.clientX;
                clientY = e.clientY;
            } else if (e.type === 'touchmove') {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            }
            
            const newX = clientX - dragOffset.x;
            const newY = clientY - dragOffset.y;
            
            // 화면 경계 체크
            const panelRect = setupPanel.getBoundingClientRect();
            const maxX = window.innerWidth - panelRect.width;
            const maxY = window.innerHeight - panelRect.height;
            
            const boundedX = Math.max(0, Math.min(newX, maxX));
            const boundedY = Math.max(0, Math.min(newY, maxY));
            
            setupPanel.style.transform = `translate(${boundedX}px, ${boundedY}px) scale(1)`;
        }

        function stopDrag() {
            if (!isDragging) return;
            
            isDragging = false;
            const setupPanel = document.getElementById('setup-panel');
            
            if (setupPanel) {
                setupPanel.style.transition = 'all 0.3s ease';
                setupPanel.style.cursor = 'default';
            }
        }

        // 키보드 단축키 지원
        document.addEventListener('keydown', function(e) {
            // ESC 키로 설정 패널 닫기
            if (e.key === 'Escape' && isSetupPanelOpen) {
                closeSetupPanel();
            }
            
            // Ctrl/Cmd + , 로 설정 패널 열기
            if ((e.ctrlKey || e.metaKey) && e.key === ',') {
                e.preventDefault();
                if (isSetupPanelOpen) {
                    closeSetupPanel();
                } else {
                    openSetupPanel();
                }
            }
        });
    </script>
</body>
</html>
