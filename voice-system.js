// ÏùåÏÑ± ÏûÖÎ†• Î∞è Ï∂úÎ†• ÏãúÏä§ÌÖú
class VoiceSystem {
    constructor() {
        this.recognition = null;
        this.synthesis = window.speechSynthesis;
        this.isListening = false;
        this.isSpeaking = false;
        this.supported = this.checkSupport();
        
        this.initSpeechRecognition();
        this.initSpeechSynthesis();
    }

    // Î∏åÎùºÏö∞Ï†Ä ÏßÄÏõê ÌôïÏù∏
    checkSupport() {
        const recognitionSupported = 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
        const synthesisSupported = 'speechSynthesis' in window;
        
        console.log('ÏùåÏÑ± Ïù∏Ïãù ÏßÄÏõê:', recognitionSupported);
        console.log('ÏùåÏÑ± Ìï©ÏÑ± ÏßÄÏõê:', synthesisSupported);
        
        return recognitionSupported && synthesisSupported;
    }

    // ÏùåÏÑ± Ïù∏Ïãù Ï¥àÍ∏∞Ìôî
    initSpeechRecognition() {
        if (!this.supported) return;

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        this.recognition = new SpeechRecognition();
        
        // ÏùåÏÑ± Ïù∏Ïãù ÏÑ§Ï†ï
        this.recognition.continuous = false;
        this.recognition.interimResults = false;
        this.recognition.lang = 'ko-KR';
        this.recognition.maxAlternatives = 1;

        // Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨
        this.recognition.onstart = () => {
            this.isListening = true;
            this.updateVoiceUI();
            console.log('ÏùåÏÑ± Ïù∏Ïãù ÏãúÏûë');
        };

        this.recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            console.log('ÏùåÏÑ± Ïù∏Ïãù Í≤∞Í≥º:', transcript);
            
            // ÏûÖÎ†• ÌïÑÎìúÏóê ÌÖçÏä§Ìä∏ ÏÑ§Ï†ï
            this.setInputText(transcript);
            
            // ÏûêÎèôÏúºÎ°ú Î©îÏãúÏßÄ Ï†ÑÏÜ° (Ï±óÎ¥á Î™®ÎìúÏóêÏÑúÎßå)
            if (window.isChatbotMode) {
                setTimeout(() => {
                    this.sendMessage(transcript);
                }, 500);
            }
        };

        this.recognition.onerror = (event) => {
            console.error('ÏùåÏÑ± Ïù∏Ïãù Ïò§Î•ò:', event.error);
            this.isListening = false;
            this.updateVoiceUI();
            
            let errorMessage = 'ÏùåÏÑ± Ïù∏Ïãù Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
            switch (event.error) {
                case 'no-speech':
                    errorMessage = 'ÏùåÏÑ±Ïù¥ Í∞êÏßÄÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.';
                    break;
                case 'audio-capture':
                    errorMessage = 'ÎßàÏù¥ÌÅ¨Ïóê Ï†ëÍ∑ºÌï† Ïàò ÏóÜÏäµÎãàÎã§. Í∂åÌïúÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.';
                    break;
                case 'not-allowed':
                    errorMessage = 'ÎßàÏù¥ÌÅ¨ ÏÇ¨Ïö© Í∂åÌïúÏù¥ Í±∞Î∂ÄÎêòÏóàÏäµÎãàÎã§.';
                    break;
                case 'network':
                    errorMessage = 'ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
                    break;
            }
            
            this.showVoiceError(errorMessage);
        };

        this.recognition.onend = () => {
            this.isListening = false;
            this.updateVoiceUI();
            console.log('ÏùåÏÑ± Ïù∏Ïãù Ï¢ÖÎ£å');
        };
    }

    // ÏùåÏÑ± Ìï©ÏÑ± Ï¥àÍ∏∞Ìôî
    initSpeechSynthesis() {
        if (!this.synthesis) return;

        // ÌïúÍµ≠Ïñ¥ ÏùåÏÑ± Ï∞æÍ∏∞
        this.voices = this.synthesis.getVoices();
        this.koreanVoice = this.voices.find(voice => 
            voice.lang.includes('ko') || voice.lang.includes('ko-KR')
        ) || this.voices[0];

        // ÏùåÏÑ± Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏ Ïù¥Î≤§Ìä∏
        this.synthesis.onvoiceschanged = () => {
            this.voices = this.synthesis.getVoices();
            this.koreanVoice = this.voices.find(voice => 
                voice.lang.includes('ko') || voice.lang.includes('ko-KR')
            ) || this.voices[0];
        };
    }

    // ÏùåÏÑ± Ïù∏Ïãù ÏãúÏûë/Ï§ëÏßÄ
    toggleSpeechRecognition() {
        if (!this.supported) {
            this.showVoiceError('Ïù¥ Î∏åÎùºÏö∞Ï†ÄÎäî ÏùåÏÑ± Í∏∞Îä•ÏùÑ ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
            return;
        }

        if (this.isListening) {
            this.stopSpeechRecognition();
        } else {
            this.startSpeechRecognition();
        }
    }

    // ÏùåÏÑ± Ïù∏Ïãù ÏãúÏûë
    startSpeechRecognition() {
        if (!this.recognition) return;
        
        try {
            this.recognition.start();
        } catch (error) {
            console.error('ÏùåÏÑ± Ïù∏Ïãù ÏãúÏûë Ïã§Ìå®:', error);
            this.showVoiceError('ÏùåÏÑ± Ïù∏ÏãùÏùÑ ÏãúÏûëÌï† Ïàò ÏóÜÏäµÎãàÎã§.');
        }
    }

    // ÏùåÏÑ± Ïù∏Ïãù Ï§ëÏßÄ
    stopSpeechRecognition() {
        if (!this.recognition) return;
        
        try {
            this.recognition.stop();
        } catch (error) {
            console.error('ÏùåÏÑ± Ïù∏Ïãù Ï§ëÏßÄ Ïã§Ìå®:', error);
        }
    }

    // ÏùåÏÑ± Ìï©ÏÑ± (TTS)
    speak(text, options = {}) {
        if (!this.synthesis || !this.koreanVoice) {
            console.warn('ÏùåÏÑ± Ìï©ÏÑ±ÏùÑ ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§.');
            return;
        }

        // Ïù¥Ï†Ñ ÏùåÏÑ± Ï§ëÏßÄ
        this.stopSpeaking();

        const utterance = new SpeechSynthesisUtterance(text);
        
        // ÏùåÏÑ± ÏÑ§Ï†ï
        utterance.voice = this.koreanVoice;
        utterance.rate = options.rate || 1.0; // ÏÜçÎèÑ (0.1 ~ 10)
        utterance.pitch = options.pitch || 1.0; // ÏùåÏ°∞ (0 ~ 2)
        utterance.volume = options.volume || 1.0; // Î≥ºÎ•® (0 ~ 1)
        utterance.lang = 'ko-KR';

        // Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨
        utterance.onstart = () => {
            this.isSpeaking = true;
            this.updateVoiceUI();
            console.log('ÏùåÏÑ± Ï∂úÎ†• ÏãúÏûë:', text.substring(0, 50) + '...');
        };

        utterance.onend = () => {
            this.isSpeaking = false;
            this.updateVoiceUI();
            console.log('ÏùåÏÑ± Ï∂úÎ†• Ï¢ÖÎ£å');
        };

        utterance.onerror = (event) => {
            console.error('ÏùåÏÑ± Ï∂úÎ†• Ïò§Î•ò:', event.error);
            this.isSpeaking = false;
            this.updateVoiceUI();
        };

        this.synthesis.speak(utterance);
    }

    // ÏùåÏÑ± Ï∂úÎ†• Ï§ëÏßÄ
    stopSpeaking() {
        if (this.synthesis && this.isSpeaking) {
            this.synthesis.cancel();
            this.isSpeaking = false;
            this.updateVoiceUI();
        }
    }

    // ÏûÖÎ†• ÌïÑÎìúÏóê ÌÖçÏä§Ìä∏ ÏÑ§Ï†ï
    setInputText(text) {
        const searchInput = document.getElementById('search-input');
        const chatbotInput = document.getElementById('chatbot-input');
        
        if (searchInput && searchInput.style.display !== 'none') {
            searchInput.value = text;
            searchInput.focus();
        } else if (chatbotInput) {
            chatbotInput.value = text;
            chatbotInput.focus();
        }
    }

    // Î©îÏãúÏßÄ Ï†ÑÏÜ° (Ï±óÎ¥á Î™®Îìú)
    sendMessage(text) {
        const chatbotSendBtn = document.getElementById('chatbot-send-btn');
        if (chatbotSendBtn) {
            // ÏûÖÎ†• ÌïÑÎìúÏóê ÌÖçÏä§Ìä∏ ÏÑ§Ï†ï
            const chatbotInput = document.getElementById('chatbot-input');
            if (chatbotInput) {
                chatbotInput.value = text;
            }
            
            // Ï†ÑÏÜ° Î≤ÑÌäº ÌÅ¥Î¶≠
            chatbotSendBtn.click();
        }
    }

    // ÏùåÏÑ± UI ÏóÖÎç∞Ïù¥Ìä∏
    updateVoiceUI() {
        const voiceBtn = document.getElementById('voice-btn');
        const voiceStatus = document.getElementById('voice-status');
        
        if (voiceBtn) {
            if (this.isListening) {
                voiceBtn.innerHTML = 'üé§';
                voiceBtn.classList.add('listening');
                voiceBtn.title = 'ÏùåÏÑ± Ïù∏Ïãù Ï§ëÏßÄ';
            } else if (this.isSpeaking) {
                voiceBtn.innerHTML = 'üîä';
                voiceBtn.classList.add('speaking');
                voiceBtn.title = 'ÏùåÏÑ± Ï∂úÎ†• Ï§ëÏßÄ';
            } else {
                voiceBtn.innerHTML = 'üé§';
                voiceBtn.classList.remove('listening', 'speaking');
                voiceBtn.title = 'ÏùåÏÑ± ÏûÖÎ†• ÏãúÏûë';
            }
        }

        if (voiceStatus) {
            if (this.isListening) {
                voiceStatus.textContent = 'Îì£Îäî Ï§ë...';
                voiceStatus.style.color = '#4CAF50';
            } else if (this.isSpeaking) {
                voiceStatus.textContent = 'ÎßêÌïòÎäî Ï§ë...';
                voiceStatus.style.color = '#2196F3';
            } else {
                voiceStatus.textContent = '';
            }
        }
    }

    // ÏùåÏÑ± Ïò§Î•ò Î©îÏãúÏßÄ ÌëúÏãú
    showVoiceError(message) {
        // ÌÜ†Ïä§Ìä∏ Î©îÏãúÏßÄ ÌëúÏãú
        const toast = document.createElement('div');
        toast.className = 'voice-toast';
        toast.textContent = message;
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #f44336;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 10000;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        `;

        document.body.appendChild(toast);

        // 3Ï¥à ÌõÑ Ï†úÍ±∞
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 300);
        }, 3000);
    }

    // ÏùåÏÑ± ÏÑ§Ï†ï Í∞ÄÏ†∏Ïò§Í∏∞
    getVoiceSettings() {
        return {
            enabled: localStorage.getItem('voiceEnabled') === 'true',
            autoSpeak: localStorage.getItem('autoSpeak') === 'true',
            rate: parseFloat(localStorage.getItem('voiceRate')) || 1.0,
            pitch: parseFloat(localStorage.getItem('voicePitch')) || 1.0,
            volume: parseFloat(localStorage.getItem('voiceVolume')) || 1.0
        };
    }

    // ÏùåÏÑ± ÏÑ§Ï†ï Ï†ÄÏû•
    saveVoiceSettings(settings) {
        localStorage.setItem('voiceEnabled', settings.enabled);
        localStorage.setItem('autoSpeak', settings.autoSpeak);
        localStorage.setItem('voiceRate', settings.rate);
        localStorage.setItem('voicePitch', settings.pitch);
        localStorage.setItem('voiceVolume', settings.volume);
    }

    // ÏûêÎèô ÏùåÏÑ± Ï∂úÎ†• (AI ÏùëÎãµ Ïãú)
    autoSpeakResponse(response) {
        const settings = this.getVoiceSettings();
        if (settings.enabled && settings.autoSpeak) {
            this.speak(response, {
                rate: settings.rate,
                pitch: settings.pitch,
                volume: settings.volume
            });
        }
    }
}

// Ï†ÑÏó≠ ÏùåÏÑ± ÏãúÏä§ÌÖú Ïù∏Ïä§ÌÑ¥Ïä§
window.voiceSystem = new VoiceSystem(); 